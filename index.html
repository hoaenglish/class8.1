<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªçc ph√≠</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      text-align: center;
      font-size: 28px;
    }
    select, button {
      padding: 10px;
      margin: 10px 0;
      width: 100%;
      font-size: 28px;
    }
    .info {
      margin-top: 20px;
      padding: 18px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #f9f9f9;
    }
    .info p {
      margin: 12px 0;
      font-size: 24px;
    }
    .amount {
      color: red;
      font-weight: bold;
      font-size: 26px;
    }
    .content {
      font-weight: bold;
      font-size: 24px;
    }
    img.qr {
      margin: 18px 0;
      max-width: 800px;
    }
    .save-btn {
      display: none; /* ·∫©n m·∫∑c ƒë·ªãnh */
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 22px;
      background: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      border: none;
    }
    .save-btn:disabled {
      background: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2 id="title">H·ªçc ph√≠</h2>
  <select id="studentSelect">
    <option value="">-- Ch·ªçn h·ªçc sinh --</option>
  </select>

  <div id="details" class="info" style="display:none;">
    <p>
      <strong>S·ªë ti·ªÅn:</strong> 
      <span id="fee" class="amount"></span> VNƒê
    </p>
    <p>
      <strong>N·ªôi dung CK:</strong> 
      <span id="info" class="content"></span>
    </p>
    <img id="qr" class="qr" src="" alt="QR Code"/>
    <br/>
    <button id="downloadQR" class="save-btn">L∆∞u ·∫£nh</button>
  </div>

  <script>
    const files = {
      "L·ªõp Anh 6": "L·ªõp Anh 6.json",
      "L·ªõp Anh 7": "L·ªõp Anh 7.json",
      "L·ªõp Anh 8.1": "L·ªõp Anh 8.1.json",
      "L·ªõp Anh 8.2": "L·ªõp Anh 8.2.json",
      "L·ªõp Anh 9": "L·ªõp Anh 9.json"
    };

	// S·ª≠a h√†m loadData ƒë·ªÉ c·∫≠p nh·∫≠t json khi m·ªü web m√† ko ƒë·ªçc l·∫°i cache
	async function loadData(sheetName) {
	    const jsonFileName = files[sheetName];
	    
	    // üí° T·∫†O THAM S·ªê NG·∫™U NHI√äN B·∫∞NG TIMESTAMP C·ª¶A CLIENT
	    const randomBuster = new Date().getTime(); 
	    
	    // G·∫Øn tham s·ªë ng·∫´u nhi√™n v√†o URL (vd: L·ªõp Anh 6.json?v=1678886400000)
	    const url = `${jsonFileName}?v=${randomBuster}`; 
	    
	    const res = await fetch(url);
	    if (!res.ok) {
	        console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c file JSON:", res.status);
	        return { title: "L·ªói t·∫£i d·ªØ li·ªáu", students: [] };
	    }
	    return await res.json();
	}
	
    (async function init() {
      const sheetName = "L·ªõp Anh 8.1"; // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
      const data = await loadData(sheetName);

      //document.getElementById("title").innerText = data[0]?.title || `H·ªçc ph√≠ Th√°ng 9 ${sheetName}`;
      document.getElementById("title").innerText = data.title || "H·ªçc ph√≠";

      const select = document.getElementById("studentSelect");

      data.students.forEach((s, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${s.class} - ${s.name}`;
        select.appendChild(opt);
      });

      const qrImg = document.getElementById("qr");
      const saveBtn = document.getElementById("downloadQR");

      select.onchange = () => {
        if (select.value === "") {
          document.getElementById("details").style.display = "none";
          return;
        }
        const s = data.students[select.value];
        const formattedFee = Number(s.fee).toLocaleString("vi-VN");
        document.getElementById("fee").innerText = formattedFee;
        document.getElementById("info").innerText = s.info;

        // ·∫©n n√∫t khi ·∫£nh ch∆∞a load
        saveBtn.style.display = "none";

        // ƒë·ªïi QR
        qrImg.src = s.qr;

        // khi ·∫£nh load xong m·ªõi cho hi·ªán n√∫t
        qrImg.onload = () => {
          saveBtn.style.display = "inline-block";
          saveBtn.onclick = async () => {
  	  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  	  if (isIOS) {
   	  // iPhone/iPad: m·ªü tab m·ªõi ƒë·ªÉ ng∆∞·ªùi d√πng gi·ªØ tay l∆∞u ·∫£nh
    	   window.open(s.qr, "_blank");
 	   } else {
   	   // PC / Android: t·∫£i tr·ª±c ti·∫øp
      	   const resp = await fetch(s.qr);
    	   const blob = await resp.blob();
    	   const url = URL.createObjectURL(blob);

   	   const a = document.createElement("a");
   	   a.href = url;
   	   a.download = s.info + ".png";
   	   a.click();

   	   URL.revokeObjectURL(url);
  	   }
	  };

        };

        document.getElementById("details").style.display = "block";
      };
    })();
  </script>
</body>
</html>


